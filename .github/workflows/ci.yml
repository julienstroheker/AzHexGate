name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  bicep-validation:
    name: Validate Bicep Templates
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      
      - name: Setup Bicep CLI
        run: |
          # Install Azure CLI if not present
          if ! command -v az &> /dev/null; then
            curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          fi
          
          # Install/Upgrade Bicep CLI
          az bicep install
          
          # Verify installation
          az bicep version
      
      - name: Validate Bicep modules
        run: |
          echo "Validating relay.bicep..."
          az bicep build --file infra/modules/relay.bicep
          
          echo "Validating appservice.bicep..."
          az bicep build --file infra/modules/appservice.bicep
          
          echo "All modules validated successfully!"
      
      - name: Validate main Bicep template
        run: |
          echo "Validating main.bicep..."
          az bicep build --file infra/main.bicep
          
          echo "Main template validated successfully!"
      
      - name: Check for generated ARM templates
        run: |
          echo "Checking that ARM templates are not committed..."
          if [ -f infra/main.json ] || [ -f infra/modules/relay.json ] || [ -f infra/modules/appservice.json ]; then
            echo "ERROR: Generated ARM templates (.json) should not be committed to the repository"
            echo "Please add *.json to .gitignore in the infra directory"
            exit 1
          fi
          echo "No ARM templates found - validation passed!"

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: bicep-validation
    permissions:
      contents: read
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      
      - name: Install CI prerequisites
        run: ./scripts/install-ci-tools.sh
      
      - name: Run go mod tidy
        run: go mod tidy
      
      - name: Check code formatting with gofmt
        run: |
          unformatted=$(gofmt -l .)
          if [ -n "$unformatted" ]; then
            echo "The following files are not formatted:"
            echo "$unformatted"
            exit 1
          fi
      
      - name: Check imports with goimports
        run: |
          unformatted=$(goimports -l .)
          if [ -n "$unformatted" ]; then
            echo "The following files have incorrect imports:"
            echo "$unformatted"
            exit 1
          fi
      
      - name: Run go vet
        run: go vet ./...
      
      - name: Run golangci-lint
        run: golangci-lint run --timeout=5m
      
      - name: Verify no files were modified by CI steps
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "ERROR: CI steps modified files. All formatting and linting must be done before committing."
            echo "Modified files:"
            git status --porcelain
            echo ""
            echo "Diff:"
            git diff
            exit 1
          fi
      
      - name: Build all packages
        run: go build ./...
      
      - name: Build azhexgate CLI
        run: |
          echo "Building azhexgate CLI..."
          go build -o azhexgate ./client
          echo "Build successful!"
      
      - name: Test azhexgate CLI help
        run: |
          echo "Testing azhexgate --help:"
          ./azhexgate --help
          echo ""
          echo "Testing azhexgate start --help:"
          ./azhexgate start --help
      
      - name: Build gateway binary
        run: |
          echo "Building gateway binary..."
          go build -o gateway-server ./gateway
          echo "Build successful!"
      
      - name: Test gateway binary help
        run: |
          echo "Testing gateway binary --help:"
          ./gateway-server --help
          echo ""
          echo "Testing gateway start --help:"
          ./gateway-server start --help
      
      - name: Test gateway server health endpoint
        run: |
          echo "Starting gateway server in background..."
          ./gateway-server start --port 9999 &
          GATEWAY_PID=$!
          echo "Gateway PID: $GATEWAY_PID"
          
          # Wait for server to start
          echo "Waiting for server to start..."
          sleep 2
          
          # Test health endpoint
          echo "Testing /healthz endpoint:"
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:9999/healthz)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n1)
          
          echo "HTTP Status Code: $HTTP_CODE"
          echo "Response Body: $BODY"
          
          # Verify response
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: Expected status code 200, got $HTTP_CODE"
            kill $GATEWAY_PID
            exit 1
          fi
          
          if [ "$BODY" != "OK" ]; then
            echo "ERROR: Expected response body 'OK', got '$BODY'"
            kill $GATEWAY_PID
            exit 1
          fi
          
          echo "Health endpoint test passed!"
          
          # Test graceful shutdown
          echo "Testing graceful shutdown..."
          kill -TERM $GATEWAY_PID
          
          # Wait for process to exit
          for i in {1..10}; do
            if ! kill -0 $GATEWAY_PID 2>/dev/null; then
              echo "Server stopped gracefully"
              break
            fi
            sleep 1
          done
          
          # Check if process is still running
          if kill -0 $GATEWAY_PID 2>/dev/null; then
            echo "ERROR: Server did not stop gracefully"
            kill -9 $GATEWAY_PID
            exit 1
          fi
          
          echo "Graceful shutdown test passed!"
      
      - name: Run tests
        run: go test ./...
      
      - name: Integration test - CLI with gateway (success path)
        run: |
          echo "Starting gateway server in background..."
          ./gateway-server start --port 8080 &
          GATEWAY_PID=$!
          echo "Gateway PID: $GATEWAY_PID"
          
          # Wait for server to start
          echo "Waiting for server to start..."
          sleep 2
          
          # Test CLI with verbose mode to see request ID and full logs
          echo "Testing CLI start command with verbose mode:"
          
          # Run CLI in background and capture output to a file
          ./azhexgate start -p 3000 --api-url http://localhost:8080 -v > /tmp/cli_output.log 2>&1 &
          CLI_PID=$!
          echo "CLI PID: $CLI_PID"
          
          # Wait for CLI to establish tunnel and print output
          sleep 3
          
          # Read the output
          OUTPUT=$(cat /tmp/cli_output.log)
          echo "$OUTPUT"
          
          # Kill the CLI process
          kill $CLI_PID 2>/dev/null || true
          
          # Verify request ID header is present in logs
          if ! echo "$OUTPUT" | grep -q "X-Client-Request-Id"; then
            echo "ERROR: Request ID header not found in logs"
            kill $GATEWAY_PID
            exit 1
          fi
          echo "✓ Request ID header found in logs"
          
          # Verify request and response logging
          if ! echo "$OUTPUT" | grep -q "HTTP Request"; then
            echo "ERROR: HTTP Request log not found"
            kill $GATEWAY_PID
            exit 1
          fi
          echo "✓ HTTP Request logged"
          
          if ! echo "$OUTPUT" | grep -q "HTTP Response"; then
            echo "ERROR: HTTP Response log not found"
            kill $GATEWAY_PID
            exit 1
          fi
          echo "✓ HTTP Response logged"
          
          # Verify tunnel established
          if ! echo "$OUTPUT" | grep -q "Tunnel established"; then
            echo "ERROR: Tunnel not established"
            kill $GATEWAY_PID
            exit 1
          fi
          echo "✓ Tunnel established successfully"
          
          # Verify public URL printed
          if ! echo "$OUTPUT" | grep -q "Public URL:"; then
            echo "ERROR: Public URL not printed"
            kill $GATEWAY_PID
            exit 1
          fi
          echo "✓ Public URL printed"
          
          # Clean up
          kill $GATEWAY_PID
          echo "Integration test (success path) passed!"
      
      - name: Integration test - CLI with gateway (retry on failure)
        run: |
          echo "Testing CLI with wrong gateway URL to verify retries..."
          
          # Use a port that doesn't have a server running
          OUTPUT=$(timeout 30 ./azhexgate start -p 3000 --api-url http://localhost:9999 -v 2>&1 || true)
          echo "$OUTPUT"
          
          # Verify retry attempts are logged
          if ! echo "$OUTPUT" | grep -q "Retrying request"; then
            echo "ERROR: Retry attempts not found in logs"
            exit 1
          fi
          echo "✓ Retry attempts logged"
          
          # Count retry attempts (should see multiple)
          RETRY_COUNT=$(echo "$OUTPUT" | grep -c "Retrying request" || true)
          echo "Found $RETRY_COUNT retry attempts"
          
          if [ "$RETRY_COUNT" -lt 2 ]; then
            echo "ERROR: Expected at least 2 retry attempts, found $RETRY_COUNT"
            exit 1
          fi
          echo "✓ Multiple retry attempts detected"
          
          # Verify request ID is present in request logs (multiple times for retries)
          REQUEST_ID_COUNT=$(echo "$OUTPUT" | grep "HTTP Request" | grep -c "X-Client-Request-Id" || true)
          echo "Found $REQUEST_ID_COUNT HTTP requests with Request ID"
          
          if [ "$REQUEST_ID_COUNT" -lt 2 ]; then
            echo "ERROR: Expected at least 2 HTTP requests with Request ID, found $REQUEST_ID_COUNT"
            exit 1
          fi
          echo "✓ Request ID present across retry attempts"
          
          echo "Integration test (retry on failure) passed!"
