# Azure Relay Real Integration

This document describes the Azure Relay integration for AzHexGate.

## Overview

AzHexGate now supports real Azure Relay Hybrid Connections for secure tunneling between the local client and the cloud gateway. This implementation follows the architecture document's security model strictly:

- **Gateway** uses Managed Identity for Azure AD authentication
- **Local Client** uses SAS tokens issued by the Management API
- **Management API** generates short-lived SAS tokens for clients

## Configuration

### Environment Variables

#### Gateway Configuration

The gateway requires the following environment variables to enable real Azure Relay integration:

```bash
# Azure Relay namespace name (e.g., "myrelay", NOT the full URL)
export AZHEXGATE_RELAY_NAMESPACE="your-relay-namespace"

# Relay shared access key name (typically "RootManageSharedAccessKey")
export AZHEXGATE_RELAY_KEY_NAME="RootManageSharedAccessKey"

# Relay shared access key value (base64 encoded)
export AZHEXGATE_RELAY_KEY="your-base64-encoded-key"

# Azure Subscription ID (required for creating Hybrid Connections)
export AZURE_SUBSCRIPTION_ID="your-subscription-id"

# Resource Group containing the Relay namespace (required for creating Hybrid Connections)
export AZURE_RESOURCE_GROUP="your-resource-group-name"

# Optional: Base domain for public URLs (default: "azhexgate.com")
export AZHEXGATE_BASE_DOMAIN="azhexgate.com"
```

If these variables are not set, the gateway will fall back to mock mode for testing and development.

**Note:** The gateway uses Azure Default Credential for authentication when creating Hybrid Connections. This supports Managed Identity (in production), Azure CLI (for local development), and environment variables.

#### Client Configuration

The client automatically detects whether it's connecting to a real Azure Relay or mock mode based on the token received from the Management API. No additional configuration is required.

### Getting Azure Relay Credentials

1. Create an Azure Relay namespace in your Azure subscription
2. Navigate to the namespace in the Azure Portal
3. Go to "Shared access policies"
4. Select "RootManageSharedAccessKey" (or create a new policy)
5. Copy the "Primary Key" value (this is your `AZHEXGATE_RELAY_KEY`)

## Components

### SAS Token Generator (`internal/azure/relay/sas.go`)

Generates Shared Access Signature tokens for authenticating with Azure Relay:
- `GenerateSASToken` - Creates tokens for both listeners and senders (token format is identical; access rights are determined by the key used)
- Tokens are time-limited and scoped to specific Hybrid Connections

### Managed Identity Token Provider (`internal/azure/relay/token.go`)

Provides Azure AD tokens using Managed Identity:
- Caches tokens and refreshes proactively before expiry
- Uses DefaultAzureCredential for flexible authentication
- Supports Managed Identity, Azure CLI, and environment variables

### Azure Relay Listener (`internal/relay/azure_listener.go`)

Real implementation of Relay listener for local clients:
- Connects to Azure Relay using WebSocket protocol
- Authenticates with SAS tokens
- Accepts incoming connections from the gateway

### Azure Relay Sender (`internal/relay/azure_sender.go`)

Real implementation of Relay sender for the gateway:
- Connects to Azure Relay using WebSocket protocol
- Authenticates with Azure AD tokens (Managed Identity)
- Creates connections to local clients

### Management Service (`gateway/management/service.go`)

Provisions tunnels and generates credentials:
- Creates unique subdomain IDs
- Generates SAS listener tokens for clients
- Returns all necessary connection information

## Testing

### Unit Tests

All components have unit tests that run without requiring Azure credentials:

```bash
go test ./internal/azure/relay/...
go test ./internal/relay/...
go test ./gateway/management/...
```

### Integration Tests

Integration tests demonstrate token generation and expiry:

```bash
go test ./internal/azure/relay/... -v -run TestIntegration
```

### Manual Testing

To test with a real Azure Relay namespace:

1. Set the required environment variables
2. Start the gateway: `./gateway-server start`
3. Start the client: `./azhexgate start --port 3000`
4. The client will connect to Azure Relay using real WebSocket connections

## Security Model

Following the architecture document strictly:

1. **Client → Relay**: SAS tokens (Listen right)
   - Generated by Management API
   - Valid for 24 hours
   - Scoped to specific Hybrid Connection

2. **Gateway → Relay**: Azure AD tokens (Send right)
   - Obtained via Managed Identity
   - Cached and refreshed automatically
   - No secrets in configuration

3. **Client → Management API**: API key
   - Stored in Key Vault (future)
   - Used to authenticate tunnel creation requests

## Development vs Production

### Development Mode (Mock)
- No Azure Relay required
- In-memory relay for testing
- All existing tests pass
- Good for local development

### Production Mode (Real Azure Relay)
- Requires Azure Relay namespace
- Real WebSocket connections
- Managed Identity for gateway
- SAS tokens for clients

The system automatically detects which mode to use based on configuration availability.

## Troubleshooting

### Gateway shows "Using mock tunnel provisioning"

This means the required environment variables are not set. Check:
- `AZHEXGATE_RELAY_NAMESPACE`
- `AZHEXGATE_RELAY_KEY_NAME`
- `AZHEXGATE_RELAY_KEY`

### Client shows "Using in-memory relay (development mode)"

This means the gateway is in mock mode. Configure the gateway with Azure Relay credentials.

### Connection errors to Azure Relay

1. Verify the relay namespace exists and is accessible
2. Check that the shared access key is correct
3. Ensure Hybrid Connections can be created in the namespace
4. Verify network connectivity to `*.servicebus.windows.net`

## Future Enhancements

- Managed Identity for SAS token generation (remove need for Relay keys in config)
- Dynamic Hybrid Connection creation/deletion
- Connection pooling and reuse
- Metrics and monitoring integration
- Support for Azure AD tokens on client side (OIDC)
